<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏–∑ –ø–æ–≥–æ–¥—ã –¥–ª—è –ë–ü–õ–ê (Open-Meteo)</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden; /* –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–æ—Å—ã –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            position: relative; /* –î–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ–Ω—é */
            background-color: #f0f0f0; /* –°–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω */
        }
        #map {
            height: calc(100vh - 120px); /* –ö–∞—Ä—Ç–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Å—é –≤—ã—Å–æ—Ç—É –º–∏–Ω—É—Å –≤—ã—Å–æ—Ç–∞ –Ω–∏–∂–Ω–µ–π –ø–∞–Ω–µ–ª–∏ */
            width: 100vw;  /* –ö–∞—Ä—Ç–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Å—é —à–∏—Ä–∏–Ω—É —ç–∫—Ä–∞–Ω–∞ */
        }
        /* –°—Ç–∏–ª—å –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º–æ–≥–æ –º–µ–Ω—é —Å–ø—Ä–∞–≤–∞ (Ventusky-style) */
        #weather-menu {
            position: absolute;
            top: 10px;
            right: -260px; /* –°–∫—Ä—ã—Ç–æ –∑–∞ –ø—Ä–∞–≤—ã–º –∫—Ä–∞–µ–º */
            width: 240px;
            height: calc(100vh - 140px); /* –í—ã—Å–æ—Ç–∞ –º–µ–Ω—é */
            background-color: rgba(255, 255, 255, 0.97);
            padding: 15px 10px 15px 15px;
            border-radius: 0 4px 4px 0;
            box-shadow: -2px 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: right 0.3s ease; /* –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ */
            overflow-y: auto; /* –ü—Ä–æ–∫—Ä—É—Ç–∫–∞, –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –±–æ–ª—å—à–æ–π */
            display: flex;
            flex-direction: column;
            border-left: 1px solid #ddd;
        }
        #weather-menu.open {
            right: 10px; /* –û—Ç–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ */
        }
        #toggle-menu-btn {
            position: absolute;
            top: 15px;
            right: 10px;
            z-index: 1001;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 4px 0 0 4px; /* –ó–∞–∫—Ä—É–≥–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Å–ª–µ–≤–∞ */
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px;
        }
        #toggle-menu-btn:hover {
            background-color: #555;
        }
        .menu-header {
            font-weight: bold;
            margin-bottom: 15px;
            text-align: left;
            font-size: 16px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .param-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
            padding: 2px 0;
        }
        .param-label {
            font-weight: 500; /* Slightly bolder than normal */
            color: #555;
        }
        .param-value {
            color: #333;
            font-weight: normal;
        }
        .restriction-details {
            background-color: #fff3cd; /* –ñ–µ–ª—Ç–æ–≤–∞—Ç—ã–π —Ñ–æ–Ω */
            padding: 8px;
            border-left: 3px solid #ffc107; /* –ñ–µ–ª—Ç–∞—è –ø–æ–ª–æ—Å–∞ */
            margin-top: 10px;
            border-radius: 3px;
            font-size: 12px;
        }
        .restriction-item {
            margin: 3px 0;
            color: #856404; /* –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ */
        }
        .no-data {
            text-align: center;
            color: #999;
            font-style: italic;
            margin-top: 20px;
            font-size: 13px;
        }
        /* –°—Ç–∏–ª—å –¥–ª—è —Ç–µ—Ä–º–æ–º–µ—Ç—Ä–∞ (–≥—Ä–∞–¥—É—Å–Ω–∏–∫) */
        .temperature-display {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 5px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        .thermometer-icon {
            font-size: 20px;
            margin-right: 10px;
            color: #e74c3c; /* –ö—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã */
        }
        .temperature-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        /* –°—Ç–∏–ª—å –¥–ª—è –Ω–∏–∂–Ω–µ–π –ø–∞–Ω–µ–ª–∏ (–∫–∞–ª–µ–Ω–¥–∞—Ä—å –∏ —à–∫–∞–ª–∞ –≤—Ä–µ–º–µ–Ω–∏) (Ventusky-style) */
        #bottom-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100px; /* –£–≤–µ–ª–∏—á–µ–Ω–∞ –≤—ã—Å–æ—Ç–∞ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
            background-color: rgba(255, 255, 255, 0.95);
            padding: 10px 15px;
            box-sizing: border-box;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px; /* –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–π –æ—Ç—Å—Ç—É–ø */
            border-top: 1px solid #ccc;
            flex-wrap: wrap; /* –î–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ —Å—Ç—Ä–æ–∫ */
        }
        .panel-section-date {
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é */
        }
        .panel-section-date label {
            font-size: 11px;
            margin-bottom: 3px;
            color: #555;
        }
        .panel-section-date input[type="date"] {
            padding: 4px;
            font-size: 11px;
            border: 1px solid #ccc;
            border-radius: 3px;
            width: 120px; /* –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é —à–∏—Ä–∏–Ω—É */
        }
        .panel-section-model {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .panel-section-model label {
            font-size: 11px;
            margin-bottom: 3px;
            color: #555;
        }
        .panel-section-model select {
            padding: 4px;
            font-size: 11px;
            border: 1px solid #ccc;
            border-radius: 3px;
            width: 120px;
        }
        .panel-section-height {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .panel-section-height label {
            font-size: 11px;
            margin-bottom: 3px;
            color: #555;
        }
        .panel-section-height select {
            padding: 4px;
            font-size: 11px;
            border: 1px solid #ccc;
            border-radius: 3px;
            width: 120px;
        }
        .timeline-container {
            flex-grow: 1; /* –®–∫–∞–ª–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Å—ë –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –º–µ—Å—Ç–æ */
            margin-left: 10px; /* –û—Ç—Å—Ç—É–ø –æ—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
            width: 100%; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å—é —à–∏—Ä–∏–Ω—É */
            margin-top: 5px;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è —à–∫–∞–ª—ã –≤—Ä–µ–º–µ–Ω–∏ (—Ç–∞–π–º–ª–∞–π–Ω) */
        .timeline-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 20px; /* –£–≤–µ–ª–∏—á–µ–Ω–∞ –≤—ã—Å–æ—Ç–∞ –¥–ª—è –ª—É—á—à–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è */
            border-radius: 5px;
            background: linear-gradient(to right, #d0ebff, #a3daff, #7ecdf7, #5bb3f6, #3eaaf5, #23a1f4, #0a98f3, #0090f2, #0088f1, #0080f0, #0078ef, #0070ee, #0068ed, #0060ec, #0058eb, #0050ea, #0048e9, #0040e8, #0038e7, #0030e6, #0028e5, #0020e4, #0018e3, #0010e2, #0008e1, #0000e0); /* –ü—Ä–∏–º–µ—Ä –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞ */
            outline: none;
            border: 1px solid #ccc;
        }
        .timeline-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 24px;
            border-radius: 3px;
            background: #333;
            cursor: pointer;
            box-shadow: 0 0 2px 0 rgba(0,0,0,0.5);
        }
        .timeline-slider::-moz-range-thumb {
            width: 16px;
            height: 24px;
            border-radius: 3px;
            background: #333;
            cursor: pointer;
            border: 1px solid #000; /* –î–ª—è Firefox */
            box-shadow: 0 0 2px 0 rgba(0,0,0,0.5);
        }
        .timeline-label {
            text-align: center;
            margin-top: 5px;
            font-size: 12px;
            font-weight: bold;
            color: #333;
        }
        /* –°—Ç–∏–ª—å –¥–ª—è –º–µ—Ç–æ–∫ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–¥ —à–∫–∞–ª–æ–π */
        .time-markers {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 5px;
            font-size: 10px;
            color: #555;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º–æ–µ –º–µ–Ω—é —Å–ø—Ä–∞–≤–∞ -->
    <button id="toggle-menu-btn">‚ò∞</button>
    <div id="weather-menu">
        <div class="menu-header">–ü–æ–≥–æ–¥–∞ (Open-Meteo)</div>
        <div id="weather-display">
            <div class="no-data">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ç–æ—á–∫—É.</div>
        </div>
    </div>

    <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å (–∫–∞–ª–µ–Ω–¥–∞—Ä—å, –º–æ–¥–µ–ª—å, –≤—ã—Å–æ—Ç–∞ –∏ —à–∫–∞–ª–∞ –≤—Ä–µ–º–µ–Ω–∏) -->
    <div id="bottom-panel">
        <div class="panel-section-date">
            <label for="selectDate">–î–∞—Ç–∞ (UTC):</label>
            <input type="date" id="selectDate" required min="" max="">
        </div>
        <div class="panel-section-model">
            <label for="selectModel">–ú–æ–¥–µ–ª—å:</label>
            <select id="selectModel">
                <option value="best_match">Best Match</option>
                <option value="ecmwf_ifs04">ECMWF IFS04</option>
                <option value="gfs_seamless">GFS Seamless</option>
            </select>
        </div>
        <div class="panel-section-height">
            <label for="selectHeight">–í—ã—Å–æ—Ç–∞:</label>
            <select id="selectHeight">
                <option value="2m">2 –º</option>
                <option value="1000hPa">~110 –º (1000–≥–ü–∞)</option>
                <option value="975hPa">~320 –º (975–≥–ü–∞)</option>
                <option value="950hPa">~500 –º (950–≥–ü–∞)</option>
                <option value="925hPa">~800 –º (925–≥–ü–∞)</option>
            </select>
        </div>
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ª–∞–π–¥–µ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏ -->
        <div class="timeline-container">
            <input type="range" id="timeline-slider" class="timeline-slider" min="0" max="0" step="1" value="0">
            <div id="timeline-label" class="timeline-label">--:--</div>
            <!-- –ú–µ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ (–ø–æ–∫–∞ –ø—É—Å—Ç—ã–µ, –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è) -->
            <div class="time-markers" id="time-markers-container">
                <!-- –ú–µ—Ç–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // --- –•–†–ê–ù–ò–õ–ò–©–ï ---
        const ALL_WEATHER_PARAMS = [
            "temperature_2m", "relative_humidity_2m", "wind_speed_10m", "wind_direction_10m", "wind_gusts_10m",
            "temperature_1000hPa", "relative_humidity_1000hPa", "wind_speed_1000hPa", "wind_direction_1000hPa",
            "temperature_975hPa", "relative_humidity_975hPa", "wind_speed_975hPa", "wind_direction_975hPa",
            "temperature_950hPa", "relative_humidity_950hPa", "wind_speed_950hPa", "wind_direction_950hPa",
            "temperature_925hPa", "relative_humidity_925hPa", "wind_speed_925hPa", "wind_direction_925hPa",
            "precipitation", "surface_pressure", "cloud_cover_low"
        ]; // –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –º—ã —Ö–æ—Ç–∏–º –∑–∞–ø—Ä–æ—Å–∏—Ç—å

        // --- –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–≥–Ω–æ–∑–∞ ---
        let HOURLY_FORECAST_DATA = null; // –•—Ä–∞–Ω–∏–º 7-–¥–Ω–µ–≤–Ω—ã–µ –ø—Ä–æ–≥–Ω–æ–∑–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Ç–æ—á–∫–∏, –º–æ–¥–µ–ª–∏ –∏ –¥–∞—Ç—ã
        let SELECTED_MARKER = null; // –•—Ä–∞–Ω–∏–º –º–∞—Ä–∫–µ—Ä
        let timelineSliderElement = null;
        let timelineLabelElement = null;
        let timeMarkersContainer = null;
        let MAX_FORECAST_DATE_STR = null; // –°—Ç—Ä–æ–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD (–±–µ—Ä–µ—Ç—Å—è –∏–∑ API)

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã ---
        let map;

        function initMap() {
            if (!map) {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã —Å —Ü–µ–Ω—Ç—Ä–æ–º –≥–¥–µ-—Ç–æ –º–µ–∂–¥—É –≤–∞—à–∏–º–∏ —Å—Ç–∞—Ä—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ (–ø—Ä–∏–º–µ—Ä–Ω–æ –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ)
                const initialCenter = [55.292, 54.685]; // –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π —Ü–µ–Ω—Ç—Ä
                map = L.map('map').setView(initialCenter, 10);

                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ—è —Ç–∞–π–ª–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, OpenStreetMap)
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–∞—Ä—Ç—É
                map.on('click', onMapClick);

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Å–ª–∞–π–¥–µ—Ä–∞
                timelineSliderElement = document.getElementById('timeline-slider');
                timelineLabelElement = document.getElementById('timeline-label');
                timeMarkersContainer = document.getElementById('time-markers-container');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
        function onMapClick(e) {
            const clickedLat = e.latlng.lat;
            const clickedLon = e.latlng.lng;

            console.log(`–ö–ª–∏–∫ –Ω–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: [${clickedLat.toFixed(5)}, ${clickedLon.toFixed(5)}]`);

            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –º–∞—Ä–∫–µ—Ä, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
            if (SELECTED_MARKER) {
                map.removeLayer(SELECTED_MARKER);
            }

            // –°–æ–∑–¥–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä
            SELECTED_MARKER = L.marker([clickedLat, clickedLon]).addTo(map);

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–≥–Ω–æ–∑–∞, —Ç–∞–∫ –∫–∞–∫ —Ç–æ—á–∫–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
            HOURLY_FORECAST_DATA = null;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–≥–Ω–æ–∑–∞ –¥–ª—è —Ç–æ—á–∫–∏ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ UI
            loadForecastDataAndShowWeatherFromUI();
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–≥–Ω–æ–∑–∞ –¥–ª—è —Ç–æ—á–∫–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (–∏–∑ UI)
        async function loadForecastDataAndShowWeatherFromUI() {
            if (!SELECTED_MARKER) {
                console.log("–ú–∞—Ä–∫–µ—Ä –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É.");
                return;
            }

            // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ –º–∞—Ä–∫–µ—Ä–∞
            const { lat, lng: lon } = SELECTED_MARKER.getLatLng();

            // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –∏–∑ UI (–¥–∞—Ç–∞ + —á–∞—Å –∏–∑ —Å–ª–∞–π–¥–µ—Ä–∞)
            const selectedDateStr = document.getElementById('selectDate').value;
            const selectedHour = parseInt(timelineSliderElement.value); // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Å–ª–∞–π–¥–µ—Ä–∞ (–∏–Ω–¥–µ–∫—Å)
            const selectedModel = document.getElementById('selectModel').value;
            const selectedHeight = document.getElementById('selectHeight').value;

            if (!selectedDateStr) {
                 document.getElementById('weather-display').innerHTML = "<div class='no-data'>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É.</div>";
                 closeMenuIfOpen(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é, –µ—Å–ª–∏ –æ—à–∏–±–∫–∞
                 return;
            }

            console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞ –¥–ª—è –¥–∞—Ç—ã ${selectedDateStr}, —á–∞—Å–∞ (–∏–Ω–¥–µ–∫—Å) ${selectedHour}, –º–æ–¥–µ–ª–∏ ${selectedModel}, –≤—ã—Å–æ—Ç—ã ${selectedHeight}`);

            // --- –ü–†–û–í–ï–†–ö–ê: –î–æ—Å—Ç—É–ø–Ω–∞ –ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ –≤–æ–æ–±—â–µ? ---
            if (MAX_FORECAST_DATE_STR && selectedDateStr > MAX_FORECAST_DATE_STR) {
                console.log(`–î–∞—Ç–∞ ${selectedDateStr} –ø—Ä–µ–≤—ã—à–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é –¥–∞—Ç—É ${MAX_FORECAST_DATE_STR}`);
                document.getElementById('weather-display').innerHTML = `<div class='no-data'>–ü—Ä–æ–≥–Ω–æ–∑ –¥–ª—è –¥–∞—Ç—ã ${selectedDateStr} –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞: ${MAX_FORECAST_DATE_STR}.</div>`;
                closeMenuIfOpen(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é, –µ—Å–ª–∏ –æ—à–∏–±–∫–∞
                return; // –í–∞–∂–Ω–æ –≤—ã–π—Ç–∏, –µ—Å–ª–∏ –¥–∞—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
            }

            // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –¥–ª—è API (HH:00:00) - —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤ –æ—Ç—á–µ—Ç–µ
            // –í—Ä–µ–º—è –±–µ—Ä–µ—Ç—Å—è –∏–∑ –∏–Ω–¥–µ–∫—Å–∞ —Å–ª–∞–π–¥–µ—Ä–∞ –≤ –º–∞—Å—Å–∏–≤–µ –¥–∞–Ω–Ω—ã—Ö
            const requestDate = selectedDateStr;
            const requestCoords = `${lat},${lon}`;
            const requestModel = selectedModel;
            const cacheKey = `${requestDate}_${requestCoords}_${requestModel}`;

            if (!HOURLY_FORECAST_DATA || HOURLY_FORECAST_DATA.cacheKey !== cacheKey) {
                console.log("–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–≤—ã–µ 7-–¥–Ω–µ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–æ—á–∫–∏, –¥–∞—Ç—ã –∏ –º–æ–¥–µ–ª–∏...");
                const apiUrl = "https://api.open-meteo.com/v1/forecast";

                const params = new URLSearchParams({
                    latitude: lat,
                    longitude: lon,
                    hourly: ALL_WEATHER_PARAMS.join(','),
                    models: selectedModel, // –í—ã–±—Ä–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å
                    forecast_days: 7, // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º 7 –¥–Ω–µ–π
                    wind_speed_unit: "ms",
                    timezone: "UTC" // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –≤—Ä–µ–º—è –≤ UTC
                });

                try {
                    const response = await fetch(`${apiUrl}?${params}`);
                    if (!response.ok) {
                        throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${response.status} ${response.statusText}`);
                    }
                    const data = await response.json();
                    console.log("–î–∞–Ω–Ω—ã–µ 7-–¥–Ω–µ–≤–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞ –ø–æ–ª—É—á–µ–Ω—ã:", data);

                    // --- –ü–†–û–í–ï–†–ö–ê: –ï—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã –≤ –æ—Ç–≤–µ—Ç–µ? ---
                    const hourlyTimes = data.hourly.time;
                    if (!hourlyTimes || hourlyTimes.length === 0) {
                        throw new Error("API –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –≤—Ä–µ–º–µ–Ω–∏.");
                    }

                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞—Ç—É –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ (YYYY-MM-DD)
                    const [reqYear, reqMonth, reqDay] = selectedDateStr.split('-').map(Number);

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –º–µ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è –¥–Ω—é (–¥–µ–Ω—å, –º–µ—Å—è—Ü, –≥–æ–¥)
                    let dateAvailable = false;
                    for (let i = 0; i < hourlyTimes.length; i++) {
                        const timeDate = new Date(hourlyTimes[i]);
                        if (timeDate.getUTCFullYear() === reqYear &&
                            timeDate.getUTCMonth() === reqMonth - 1 && // –ú–µ—Å—è—Ü—ã –≤ JS –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å 0
                            timeDate.getUTCDate() === reqDay) {
                                dateAvailable = true;
                                break; // –ù–∞—à–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∑–∞–ø–∏—Å—å –¥–ª—è –¥–Ω—è
                        }
                    }

                    if (!dateAvailable) {
                        // –≠—Ç–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏, –µ—Å–ª–∏ MAX_FORECAST_DATE_STR –±—ã–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã—à–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞.
                        // –ù–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π:
                        const lastAPIDate = new Date(hourlyTimes[hourlyTimes.length - 1]).toISOString().split('T')[0];
                        throw new Error(`–ü—Ä–æ–≥–Ω–æ–∑ –¥–ª—è –¥–∞—Ç—ã ${selectedDateStr} –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. API –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –¥–æ ${lastAPIDate}.`);
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É –∏–∑ API (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –æ–Ω–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞)
                    const lastTimeISO = hourlyTimes[hourlyTimes.length - 1];
                    const lastDate = new Date(lastTimeISO);
                    const maxDateUTC = Date.UTC(lastDate.getUTCFullYear(), lastDate.getUTCMonth(), lastDate.getUTCDate());
                    const maxDate = new Date(maxDateUTC);
                    MAX_FORECAST_DATE_STR = maxDate.toISOString().split('T')[0];

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –∫–ª—é—á –∫—ç—à–∞
                    HOURLY_FORECAST_DATA = {
                         hourly: data.hourly,
                        cacheKey: cacheKey
                    };

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ª–∞–π–¥–µ—Ä –∏ –º–µ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏
                    updateTimelineSlider(hourlyTimes);

                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ 7-–¥–Ω–µ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–≥–Ω–æ–∑–∞:", error);
                    const errorMessage = error && typeof error.message === 'string' ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                    document.getElementById('weather-display').innerHTML = `<div class='no-data'>–û—à–∏–±–∫–∞: ${errorMessage}</div>`;
                    closeMenuIfOpen(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é, –µ—Å–ª–∏ –æ—à–∏–±–∫–∞
                    return; // –í–∞–∂–Ω–æ –≤—ã–π—Ç–∏, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –¥–∞—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
                }
            } else {
                 console.log("–ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ 7-–¥–Ω–µ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.");
                 // –î–∞–∂–µ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω—ã, –Ω–∞–º –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å–ª–∞–π–¥–µ—Ä, –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –∏–ª–∏ –¥–∞—Ç–∞ –ø–æ–º–µ–Ω—è–ª–∞—Å—å
                 updateTimelineSlider(HOURLY_FORECAST_DATA.hourly.time);
            }

            // –ò—â–µ–º –∏–Ω–¥–µ–∫—Å, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —á–∞—Å—É –≤ –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            // selectedHour —Ç–µ–ø–µ—Ä—å —è–≤–ª—è–µ—Ç—Å—è –∏–Ω–¥–µ–∫—Å–æ–º —Å–ª–∞–π–¥–µ—Ä–∞
            const hourlyTimes = HOURLY_FORECAST_DATA.hourly.time;
            let targetIndex = selectedHour;
            if (targetIndex < 0 || targetIndex >= hourlyTimes.length) {
                console.error("–ù–µ–≤–µ—Ä–Ω—ã–π –∏–Ω–¥–µ–∫—Å –≤—Ä–µ–º–µ–Ω–∏:", targetIndex);
                document.getElementById('weather-display').innerHTML = `<div class='no-data'>–ù–µ–≤–µ—Ä–Ω—ã–π –∏–Ω–¥–µ–∫—Å –≤—Ä–µ–º–µ–Ω–∏.</div>`;
                return; // –í—ã—Ö–æ–¥–∏–º, –µ—Å–ª–∏ –∏–Ω–¥–µ–∫—Å –Ω–µ –Ω–∞–π–¥–µ–Ω
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∞–ª–∏–∑ –¥–ª—è –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –∏ –≤—ã—Å–æ—Ç—ã
            showWeatherAnalysis(HOURLY_FORECAST_DATA.hourly, targetIndex, selectedHeight, { lat, lon }, hourlyTimes[targetIndex]);

            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é
            openMenu();
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ª–∞–π–¥–µ—Ä–∞ –∏ –º–µ—Ç–æ–∫ –≤—Ä–µ–º–µ–Ω–∏
        function updateTimelineSlider(timesArray) {
            if (!timelineSliderElement || !timesArray || timesArray.length === 0) return;

            timelineSliderElement.min = 0;
            timelineSliderElement.max = timesArray.length - 1;

            // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫—É —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
            const currentIndex = parseInt(timelineSliderElement.value);
            if (currentIndex >= 0 && currentIndex < timesArray.length) {
                timelineLabelElement.textContent = new Date(timesArray[currentIndex]).toISOString().replace('T', ' ').substring(0, 16) + ' UTC';
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–¥ —Å–ª–∞–π–¥–µ—Ä–æ–º
            timeMarkersContainer.innerHTML = ''; // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            const step = Math.ceil(timesArray.length / 7); // –ü—Ä–∏–º–µ—Ä–Ω–æ 7 –º–µ—Ç–æ–∫
            for (let i = 0; i < timesArray.length; i += step) {
                const time = new Date(timesArray[i]);
                const timeStr = time.getHours().toString().padStart(2, '0');
                const markerSpan = document.createElement('span');
                markerSpan.textContent = timeStr;
                timeMarkersContainer.appendChild(markerSpan);
            }
            // –î–æ–±–∞–≤–∏–º –ø–æ—Å–ª–µ–¥–Ω—é—é –º–µ—Ç–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π
            if ((timesArray.length - 1) % step !== 0) {
                const lastTime = new Date(timesArray[timesArray.length - 1]);
                const lastTimeStr = lastTime.getHours().toString().padStart(2, '0');
                const lastMarkerSpan = document.createElement('span');
                lastMarkerSpan.textContent = lastTimeStr;
                timeMarkersContainer.appendChild(lastMarkerSpan);
            }
        }


        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–≥–æ–¥—ã –≤ –º–µ–Ω—é
        function showWeatherAnalysis(hourlyData, index, height, coords, timeISO) {
            if (!hourlyData || index < 0 || index >= hourlyData.time.length || !coords) {
                console.error("–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.");
                document.getElementById('weather-display').innerHTML = "<div class='no-data'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</div>";
                return;
            }

            const { lat, lon } = coords;
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const displayTime = timeISO.replace('T', ' ').substring(0, 16) + ' UTC';

            // --- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –∏ –≤—ã—Å–æ—Ç—ã ---
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—É—Ñ—Ñ–∏–∫—Å –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã—Å–æ—Ç—ã
            let suffix = '';
            switch(height) {
                case '2m':
                    suffix = '_2m'; // –î–ª—è 2–º –∏—Å–ø–æ–ª—å–∑—É–µ–º _2m, –Ω–æ –≤–µ—Ç–µ—Ä –∏ –ø–æ—Ä—ã–≤—ã —Å 10–º
                    break;
                case '1000hPa':
                    suffix = '_1000hPa';
                    break;
                case '975hPa':
                    suffix = '_975hPa';
                    break;
                case '950hPa':
                    suffix = '_950hPa';
                    break;
                case '925hPa':
                    suffix = '_925hPa';
                    break;
                default:
                    suffix = '_2m'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 2–º
            }

            // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            // –î–ª—è 2–º –∏—Å–ø–æ–ª—å–∑—É–µ–º _2m –¥–ª—è —Ç–µ–º–ø. –∏ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏, _10m –¥–ª—è –≤–µ—Ç—Ä–∞ –∏ –ø–æ—Ä—ã–≤–æ–≤
            let temp = null, humidity = null, wind_speed = null, wind_direction = null, wind_gusts = null;
            if (height === '2m') {
                temp = hourlyData[`temperature_2m`][index];
                humidity = hourlyData[`relative_humidity_2m`][index];
                wind_speed = hourlyData[`wind_speed_10m`][index];
                wind_direction = hourlyData[`wind_direction_10m`][index];
                wind_gusts = hourlyData[`wind_gusts_10m`][index];
            } else {
                // –î–ª—è –¥—Ä—É–≥–∏—Ö –≤—ã—Å–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Å—É—Ñ—Ñ–∏–∫—Å
                temp = hourlyData[`temperature${suffix}`][index];
                humidity = hourlyData[`relative_humidity${suffix}`][index];
                wind_speed = hourlyData[`wind_speed${suffix}`][index];
                wind_direction = hourlyData[`wind_direction${suffix}`][index];
                // –ü–æ—Ä—ã–≤—ã –≤–µ—Ç—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –Ω–∞ 10–º (2–º), –ø–æ—ç—Ç–æ–º—É –¥–ª—è –¥—Ä—É–≥–∏—Ö –≤—ã—Å–æ—Ç –±—É–¥–µ—Ç null
                wind_gusts = null; // –∏–ª–∏ hourlyData[`wind_gusts${suffix}`][index] –µ—Å–ª–∏ –æ–Ω–∏ –¥–æ—Å—Ç—É–ø–Ω—ã (–æ–±—ã—á–Ω–æ –Ω–µ—Ç)
            }

            // –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–Ω–µ –∑–∞–≤–∏—Å—è—â–∏–µ –æ—Ç –≤—ã—Å–æ—Ç—ã, –∏–ª–∏ —Å –æ–±—â–µ–π –≤—ã—Å–æ—Ç–æ–π)
            const precipitation = hourlyData.precipitation[index];
            const surface_pressure_hpa = hourlyData.surface_pressure[index]; // –î–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ–≥–¥–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –∑–µ–º–ª–∏
            const cloud_cover_low = hourlyData.cloud_cover_low[index]; // –ü–æ–∫—Ä—ã—Ç–∏–µ –Ω–∏–∑–∫–∏—Ö –æ–±–ª–∞–∫–æ–≤ –Ω–∞ —É—Ä–æ–≤–Ω–µ –∑–µ–º–ª–∏

            // --- –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –¥–∞–≤–ª–µ–Ω–∏—è ---
            const pressure_mmhg = surface_pressure_hpa !== null ? (surface_pressure_hpa * 0.750062) : null;

            // --- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ —Å —ç–º–æ–¥–∑–∏ ---
            let reportHtml = `<div class="param-row"><span class="param-label">üìç [${lat.toFixed(5)}, ${lon.toFixed(5)}]</span></div>`;
            reportHtml += `<div class="param-row"><span class="param-label">üìÖ ${displayTime}</span></div>`;
            reportHtml += `<div class="param-row"><span class="param-label">üìè –í—ã—Å–æ—Ç–∞: ${height}</span></div>`;

            // --- –î–æ–±–∞–≤–ª—è–µ–º "–≥—Ä–∞–¥—É—Å–Ω–∏–∫" ---
            reportHtml += `<div class="temperature-display">`;
            reportHtml += `<div class="thermometer-icon">üå°Ô∏è</div>`;
            reportHtml += `<div class="temperature-value">${temp !== null ? temp.toFixed(1) + '¬∞C' : 'N/A'}</div>`;
            reportHtml += `</div>`;

            reportHtml += `<div class="param-row"><span class="param-label">üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å:</span><span class="param-value">${humidity !== null ? humidity.toFixed(0) + '%' : 'N/A'}</span></div>`;
            reportHtml += `<div class="param-row"><span class="param-label">üí® –í–µ—Ç–µ—Ä:</span><span class="param-value">${wind_speed !== null ? wind_speed.toFixed(1) + ' –º/—Å' : 'N/A'} (${wind_direction !== null ? degreesToCardinal(wind_direction) : 'N/A'})</span></div>`;
            reportHtml += `<div class="param-row"><span class="param-label">üå™Ô∏è –ü–æ—Ä—ã–≤—ã:</span><span class="param-value">${wind_gusts !== null ? wind_gusts.toFixed(1) + ' –º/—Å' : 'N/A (–Ω–∞ 2–º)'}</span></div>`;
            reportHtml += `<div class="param-row"><span class="param-label">üåßÔ∏è –û—Å–∞–¥–∫–∏:</span><span class="param-value">${precipitation !== null ? precipitation.toFixed(1) + ' –º–º/—á' : 'N/A'}</span></div>`;

            // --- –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–µ–Ω–¥–∞ –¥–∞–≤–ª–µ–Ω–∏—è ---
            let pressure_trend_html = "";
            let pressure_display = 'N/A';
            if (index > 0) {
                const currentPressureHpa = surface_pressure_hpa;
                const prevPressureHpa = hourlyData.surface_pressure[index - 1];

                if (currentPressureHpa !== null && prevPressureHpa !== null) {
                    const currentPressureMmHg = currentPressureHpa * 0.750062;
                    const prevPressureMmHg = prevPressureHpa * 0.750062;
                    pressure_display = currentPressureMmHg.toFixed(1) + ' –º–º.—Ä—Ç.—Å—Ç.';
                    if (currentPressureMmHg < prevPressureMmHg) {
                         pressure_trend_html = " ‚¨áÔ∏è";
                    }
                } else {
                    pressure_display = (currentPressureHpa !== null ? (currentPressureHpa * 0.750062).toFixed(1) : 'N/A') + ' –º–º.—Ä—Ç.—Å—Ç.';
                }
            } else {
                pressure_display = (surface_pressure_hpa !== null ? (surface_pressure_hpa * 0.750062).toFixed(1) : 'N/A') + ' –º–º.—Ä—Ç.—Å—Ç.';
            }

            reportHtml += `<div class="param-row"><span class="param-label">üîΩ –î–∞–≤–ª–µ–Ω–∏–µ:</span><span class="param-value">${pressure_display}${pressure_trend_html}</span></div>`;
            reportHtml += `<div class="param-row"><span class="param-label">‚òÅÔ∏è –û–±–ª–∞–∫–∞ (–Ω–∏–∑–∫–∏–µ):</span><span class="param-value">${cloud_cover_low !== null ? cloud_cover_low.toFixed(0) + '%' : 'N/A'}</span></div>`;

            // --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –∏ —Å–±–æ—Ä –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π ---
            const restrictionDetails = [];

            if (precipitation !== null && precipitation > 0) {
                restrictionDetails.push({ emoji: "‚òî", param: "–û—Å–∞–¥–∫–∏", value: `${precipitation.toFixed(1)} –º–º/—á`, condition: "> 0 –º–º/—á" });
            }
            if (temp !== null) {
                if (temp > 40) {
                    restrictionDetails.push({ emoji: "üî•", param: "–¢–µ–º–ø.", value: `${temp.toFixed(1)}¬∞C`, condition: "> 40¬∞C" });
                }
                if (temp < -40) {
                    restrictionDetails.push({ emoji: "‚ùÑÔ∏è", param: "–¢–µ–º–ø.", value: `${temp.toFixed(1)}¬∞C`, condition: "< -40¬∞C" });
                }
            }
            if (humidity !== null && humidity > 87) {
                restrictionDetails.push({ emoji: "üíß", param: "–í–ª–∞–∂–Ω–æ—Å—Ç—å", value: `${humidity.toFixed(0)}%`, condition: "> 87%" });
            }
            if (wind_speed !== null && wind_speed > 10) {
                restrictionDetails.push({ emoji: "üí®", param: "–í–µ—Ç–µ—Ä", value: `${wind_speed.toFixed(1)} –º/—Å`, condition: "> 10 –º/—Å" });
            }
            if (wind_gusts !== null && wind_gusts > 15) {
                restrictionDetails.push({ emoji: "üå™Ô∏è", param: "–ü–æ—Ä—ã–≤—ã", value: `${wind_gusts.toFixed(1)} –º/—Å`, condition: "> 15 –º/—Å" });
            }
            if (humidity !== null && humidity >= 95) {
                restrictionDetails.push({ emoji: "üå´Ô∏è", param: "–í–ª–∞–∂–Ω–æ—Å—Ç—å (—Ç—É–º–∞–Ω)", value: `${humidity.toFixed(0)}%`, condition: ">= 95%" });
            }

            // --- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è ---
            if (restrictionDetails.length > 0) {
                reportHtml += `<div class="param-row"><span class="param-label">‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:</span><span class="param-value">${restrictionDetails.map(r => r.emoji).join(' ')}</span></div>`;
                reportHtml += '<div class="restriction-details">';
                restrictionDetails.forEach(detail => {
                    reportHtml += `<div class="restriction-item">${detail.emoji} ${detail.param}: ${detail.value} (${detail.condition})</div>`;
                });
                reportHtml += '</div>';
                reportHtml += `<div class="param-row"><span class="param-label">‚ùå –†–µ—à–µ–Ω–∏–µ:</span><span class="param-value">–ü–æ–ª—ë—Ç –ù–ï —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è.</span></div>`;
            } else {
                const windDirStr = wind_direction !== null ? degreesToCardinal(wind_direction) : 'N/A';
                reportHtml += `<div class="param-row"><span class="param-label">‚úÖ –†–µ—à–µ–Ω–∏–µ:</span><span class="param-value">–ü–æ–ª—ë—Ç –≤–æ–∑–º–æ–∂–µ–Ω, –≤–µ—Ç–µ—Ä ${windDirStr}. üõ´</span></div>`;
            }

            if (pressure_trend_html) {
                reportHtml += `<div class="param-row"><span class="param-label">üìà –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</span><span class="param-value">–î–∞–≤–ª–µ–Ω–∏–µ –ø–∞–¥–∞–µ—Ç.${pressure_trend_html}</span></div>`;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–µ–Ω—é
            document.getElementById('weather-display').innerHTML = reportHtml;
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é
        function openMenu() {
            document.getElementById('weather-menu').classList.add('open');
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é
        function closeMenu() {
            document.getElementById('weather-menu').classList.remove('open');
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é, –µ—Å–ª–∏ –æ–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
        function closeMenuIfOpen() {
            const menu = document.getElementById('weather-menu');
            if (menu.classList.contains('open')) {
                closeMenu();
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≥—Ä–∞–¥—É—Å–æ–≤ –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        function degreesToCardinal(degrees) {
            if (degrees === null || degrees === undefined) return "N/A";
            const val = Math.round(degrees / 22.5) % 16;
            const arr = ['–°', '–°–°–í', '–°–í', '–í–°–í', '–í', '–í–Æ–í', '–Æ–í', '–Æ–Æ–í', '–Æ', '–Æ–Æ–ó', '–Æ–ó', '–ó–Æ–ó', '–ó', '–ó–°–ó', '–°–ó', '–°–°–ó'];
            return arr[val];
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ª–∏–º–∏—Ç–æ–≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –∏–∑ API (–¥–ª—è Open-Meteo)
        async function setCalendarLimitsFromAPI() {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–ª–∏ —Ü–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            const defaultLat = 55.292;
            const defaultLon = 54.685;

            const apiUrl = "https://api.open-meteo.com/v1/forecast";

            const params = new URLSearchParams({
                latitude: defaultLat,
                longitude: defaultLon,
                hourly: "temperature_2m", // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏
                models: "best_match", // –ò—Å–ø–æ–ª—å–∑—É–µ–º best_match –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞
                forecast_days: 7 // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º 7 –¥–Ω–µ–π
            });

            try {
                const response = await fetch(`${apiUrl}?${params}`);
                if (!response.ok) {
                    console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ª–∏–º–∏—Ç—ã –¥–∞—Ç—ã –∏–∑ Open-Meteo API, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback.");
                    // Fallback: —Å–µ–≥–æ–¥–Ω—è + 7 –¥–Ω–µ–π
                    const fallbackMaxDate = new Date();
                    fallbackMaxDate.setDate(fallbackMaxDate.getDate() + 7);
                    MAX_FORECAST_DATE_STR = fallbackMaxDate.toISOString().split('T')[0];
                } else {
                    const data = await response.json();
                    console.log("–î–∞–Ω–Ω—ã–µ Open-Meteo –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞ –¥–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã:", data);

                    const hourlyTimes = data.hourly.time;
                    if (!hourlyTimes || hourlyTimes.length === 0) {
                        throw new Error("Open-Meteo API –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞.");
                    }

                    // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –¥–æ—Å—Ç—É–ø–Ω—É—é –¥–∞—Ç—É –∏–∑ –æ—Ç–≤–µ—Ç–∞
                    const lastTimeISO = hourlyTimes[hourlyTimes.length - 1];
                    const lastDate = new Date(lastTimeISO);
                    // –û–∫—Ä—É–≥–ª—è–µ–º –≤–Ω–∏–∑ –¥–æ –Ω–∞—á–∞–ª–∞ –¥–Ω—è UTC
                    const maxDateUTC = Date.UTC(lastDate.getUTCFullYear(), lastDate.getUTCMonth(), lastDate.getUTCDate());
                    const maxDate = new Date(maxDateUTC);

                    MAX_FORECAST_DATE_STR = maxDate.toISOString().split('T')[0];
                    console.log("–ù–∞–π–¥–µ–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞ Open-Meteo:", MAX_FORECAST_DATE_STR);
                }

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
                const today = new Date();
                const minDateStr = today.toISOString().split('T')[0];

                const dateInput = document.getElementById('selectDate');
                dateInput.setAttribute('min', minDateStr);
                if (MAX_FORECAST_DATE_STR) {
                    dateInput.setAttribute('max', MAX_FORECAST_DATE_STR);
                    // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –≤—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç max
                    if (dateInput.value > MAX_FORECAST_DATE_STR) {
                        dateInput.value = MAX_FORECAST_DATE_STR;
                    }
                }

                console.log(`–ö–∞–ª–µ–Ω–¥–∞—Ä—å Open-Meteo –æ–≥—Ä–∞–Ω–∏—á–µ–Ω: min=${minDateStr}, max=${MAX_FORECAST_DATE_STR || 'not set'}`);

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
                dateInput.valueAsDate = today;

            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–æ–≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –∏–∑ Open-Meteo API:", error);
                // Fallback: —Å–µ–≥–æ–¥–Ω—è + 7 –¥–Ω–µ–π
                const fallbackMaxDate = new Date();
                fallbackMaxDate.setDate(fallbackMaxDate.getDate() + 7);
                MAX_FORECAST_DATE_STR = fallbackMaxDate.toISOString().split('T')[0];
                const today = new Date();
                const minDateStr = today.toISOString().split('T')[0];

                const dateInput = document.getElementById('selectDate');
                dateInput.setAttribute('min', minDateStr);
                dateInput.setAttribute('max', MAX_FORECAST_DATE_STR);

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
                dateInput.valueAsDate = today;
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É
        window.onload = async function() {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è –∏–∑ Open-Meteo API
            await setCalendarLimitsFromAPI();

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
            initMap();

            // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é
            document.getElementById('toggle-menu-btn').addEventListener('click', function() {
                const menu = document.getElementById('weather-menu');
                if (menu.classList.contains('open')) {
                    closeMenu();
                } else {
                    openMenu();
                }
            });

            // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–ª–∞–π–¥–µ—Ä–∞
            timelineSliderElement.oninput = function() {
                // selectedHour —Ç–µ–ø–µ—Ä—å —è–≤–ª—è–µ—Ç—Å—è –∏–Ω–¥–µ–∫—Å–æ–º
                const index = parseInt(this.value);
                // –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è –∏–∑ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ –∏–Ω–¥–µ–∫—Å—É
                if (HOURLY_FORECAST_DATA && index >= 0 && index < HOURLY_FORECAST_DATA.hourly.time.length) {
                    const timeISO = HOURLY_FORECAST_DATA.hourly.time[index];
                    const displayTime = new Date(timeISO).toISOString().replace('T', ' ').substring(0, 16) + ' UTC';
                    timelineLabelElement.textContent = displayTime;
                } else {
                     timelineLabelElement.textContent = '--:--';
                }

                // –ï—Å–ª–∏ –º–∞—Ä–∫–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ (–∏—Å–ø–æ–ª—å–∑—É—è –∫—ç—à)
                if (SELECTED_MARKER) {
                    loadForecastDataAndShowWeatherFromUI();
                }
                // –ï—Å–ª–∏ –º–∞—Ä–∫–µ—Ä –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ —Å–ª–∞–π–¥–µ—Ä–∞
            };

            // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–æ–¥–µ–ª–∏ –∏ –≤—ã—Å–æ—Ç—ã
            document.getElementById('selectModel').addEventListener('change', function() {
                 if (SELECTED_MARKER) {
                    loadForecastDataAndShowWeatherFromUI();
                 }
            });

            document.getElementById('selectHeight').addEventListener('change', function() {
                 if (SELECTED_MARKER) {
                    loadForecastDataAndShowWeatherFromUI();
                 }
            });
        };

    </script>
</body>
</html>